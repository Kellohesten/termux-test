#!/bin/bash

GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${GREEN}–ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...${NC}"

cd /root/MCC/termux-test || {
    echo -e "${RED}–ü–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!${NC}"
    exit 1
}

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
git rev-parse HEAD > .previous_version

# –¢—è–Ω–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo -e "${GREEN}–û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ GitHub...${NC}"
git pull origin main

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo -e "${GREEN}–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏...${NC}"
pip3 install -r requirements.txt --upgrade

# –ò—â–µ–º –∏ —É–±–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo -e "${GREEN}–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...${NC}"
pkill -f "python3.*run.py"
sleep 3

# –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ screen
echo -e "${GREEN}–ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...${NC}"
screen -dmS web-app python3 run.py

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å –ª–∏
sleep 3
if pgrep -f "python3.*run.py" > /dev/null; then
    echo -e "${GREEN}‚úÖ –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ!${NC}"
    echo -e "üåê –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://$(curl -s ifconfig.me):5000"
    echo -e "üìä API: http://$(curl -s ifconfig.me):5000/api"
    echo -e "üíª –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è: screen -r web-app"
else
    echo -e "${RED}‚ùå –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å${NC}"
fi
