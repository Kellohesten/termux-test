name: Deploy to Termux

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Install sshpass
      run: sudo apt-get update && sudo apt-get install -y sshpass
    
    - name: Deploy via SSH (with password)
      env:
        SSHPASS: ${{ secrets.TERMUX_PASSWORD }}
      run: |
        sshpass -e ssh -o StrictHostKeyChecking=no -p ${{ secrets.TERMUX_PORT }} \
          ${{ secrets.TERMUX_USER }}@${{ secrets.TERMUX_HOST }} \
          "cd ~/termux-test && \
           git pull && \
           pkill -f webka.py || true && \
           nohup python webka.py > webka.log 2>&1 &"
    
    - name: Health check
      run: |
        sleep 5
        sshpass -e ssh -o StrictHostKeyChecking=no -p ${{ secrets.TERMUX_PORT }} \
          ${{ secrets.TERMUX_USER }}@${{ secrets.TERMUX_HOST }} \
          "pgrep -f webka.py && echo '✅ Деплой успешен!' || echo '❌ Ошибка запуска'"
