name: Deploy to Termux

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # ручной запуск

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.TERMUX_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ secrets.TERMUX_PORT }} ${{ secrets.TERMUX_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to Termux
      run: |
        # Создаём папку проекта
        ssh -p ${{ secrets.TERMUX_PORT }} ${{ secrets.TERMUX_USER }}@${{ secrets.TERMUX_HOST }} \
          "mkdir -p ~/termux-uptime-bot"
        
        # Копируем файлы
        scp -P ${{ secrets.TERMUX_PORT }} \
          webka.py \
          requirements.txt \
          ${{ secrets.TERMUX_USER }}@${{ secrets.TERMUX_HOST }}:~/termux-uptime-bot/
        
        # Устанавливаем зависимости и запускаем
        ssh -p ${{ secrets.TERMUX_PORT }} ${{ secrets.TERMUX_USER }}@${{ secrets.TERMUX_HOST }} \
          "cd ~/termux-uptime-bot && \
           pip install -r requirements.txt && \
           pkill -f webka.py || true && \
           nohup python webka.py > webka.log 2>&1 &"
    
    - name: Health check
      run: |
        sleep 5
        ssh -p ${{ secrets.TERMUX_PORT }} ${{ secrets.TERMUX_USER }}@${{ secrets.TERMUX_HOST }} \
          "pgrep -f webka.py && echo '✅ Деплой успешен!' || echo '❌ Ошибка запуска'"